<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Full Exporter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>
<body>
    <section class="section">
        <div class="container" style="max-width: 600px;">
            <div class="box">
                <h1 class="title is-4 has-text-centered">All Data Exporter</h1>
                
                <div class="field">
                    <label class="label">テスト入力 (JSON)</label>
                    <textarea id="jsonInput" class="textarea" rows="2">{"msg": "こんにちは！"}</textarea>
                </div>
                <div class="buttons is-centered">
                    <button onclick="saveToBoth()" class="button is-small is-dark">両方に適当に保存</button>
                </div>

                <hr>

                <div class="columns is-multiline">
                    <div class="column is-12">
                        <button onclick="downloadAllLocal()" class="button is-success is-fullwidth">
                            <strong>LocalStorage 全出力</strong>
                        </button>
                    </div>
                    <div class="column is-12">
                        <button onclick="downloadAllIDB()" class="button is-info is-fullwidth">
                            <strong>IndexedDB 全出力</strong>
                        </button>
                    </div>
                </div>

                <div id="status" class="notification is-light is-hidden mt-3"></div>
            </div>
        </div>
    </section>

    <script>
        const dbName = "FullExportDB";
        const storeName = "allData";

        // メッセージ表示
        function notify(text) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.classList.remove('is-hidden');
            setTimeout(() => status.classList.add('is-hidden'), 3000);
        }

        // ダウンロード実行（共通）
        function downloadFile(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        // --- 1. LocalStorage 全出力 ---
        function downloadAllLocal() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                try {
                    // JSONならパースして保存、そうでなければ文字列のまま
                    allData[key] = JSON.parse(value);
                } catch {
                    allData[key] = value;
                }
            }
            downloadFile(allData, 'all_local_storage.json');
            notify('LocalStorageの全データを書き出したよ！');
        }

        // --- 2. IndexedDB 全出力 ---
        function downloadAllIDB() {
            const req = indexedDB.open(dbName, 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore(storeName, {keyPath: "id", autoIncrement: true});
            
            req.onsuccess = e => {
                const db = e.target.result;
                const transaction = db.transaction(storeName, "readonly");
                const store = transaction.objectStore(storeName);
                
                // 全件取得
                const getAllReq = store.getAll();
                getAllReq.onsuccess = () => {
                    downloadFile(getAllReq.result, 'all_indexed_db.json');
                    notify('IndexedDBの全データを書き出したよ！');
                };
            };
        }

        // テスト用：保存処理
        function saveToBoth() {
            const val = document.getElementById('jsonInput').value;
            let data;
            try { data = JSON.parse(val); } catch { return alert('JSONが正しくないよ'); }

            // LocalStorageにランダムなキーで保存
            localStorage.setItem("test_" + Date.now(), JSON.stringify(data));

            // IndexedDBに保存
            const req = indexedDB.open(dbName, 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore(storeName, {keyPath: "id", autoIncrement: true});
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction(storeName, "readwrite").objectStore(storeName).add({content: data, timestamp: new Date()});
                notify('両方にテストデータを追加したよ！');
            };
        }
    </script>
</body>
</html>
